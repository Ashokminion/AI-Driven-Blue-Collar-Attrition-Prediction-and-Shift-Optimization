from fpdf import FPDF
import datetime
import os

class ReportGenerator(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 16)
        self.cell(0, 10, 'AI-Driven Fatigue-Aware Shift Optimization System', 0, 1, 'C')
        self.set_font('Arial', 'I', 10)
        self.cell(0, 10, f'Confidential HR Intelligence Report - {datetime.date.today()}', 0, 1, 'C')
        self.ln(10)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.cell(0, 10, f'Page {self.page_no()} | Generated by ShiftSync AI', 0, 0, 'C')

    def generate_pdf(self, df, predictions, optimized, output_path="reports/Executive_Summary.pdf"):
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        self.add_page()
        
        # Section 1: Workforce Overview
        self.set_font('Arial', 'B', 14)
        self.cell(0, 10, '1. Workforce Overview', 0, 1)
        self.set_font('Arial', '', 12)
        self.cell(0, 10, f'- Total Workforce Analyzed: {len(df)} Employees', 0, 1)
        self.cell(0, 10, f'- High Risk Instances Detected: {len(predictions[predictions["Attrition_Risk"] == "High"])}', 0, 1)
        self.cell(0, 10, f'- Avg Workforce Fatigue: {df["Fatigue_Score"].mean():.2f}', 0, 1)
        self.ln(10)

        # Section 2: High Risk Employees Table
        self.set_font('Arial', 'B', 14)
        self.cell(0, 10, '2. High Attrition Risk Registry', 0, 1)
        self.set_font('Arial', 'B', 10)
        self.cell(40, 10, 'Employee ID', 1)
        self.cell(60, 10, 'Risk Level', 1)
        self.cell(50, 10, 'Probability', 1)
        self.ln()

        self.set_font('Arial', '', 10)
        high_risk = predictions[predictions['Attrition_Risk'] == 'High'].head(15)
        for _, row in high_risk.iterrows():
            self.cell(40, 8, str(row['Employee_ID']), 1)
            self.cell(60, 8, str(row['Attrition_Risk']), 1)
            self.cell(50, 8, f"{row['Probability']*100:.2f}%", 1)
            self.ln()
            
        self.add_page()
        # Section 3: Optimization Recommendations
        self.set_font('Arial', 'B', 14)
        self.cell(0, 10, '3. Critical Roster Optimization', 0, 1)
        self.set_font('Arial', 'B', 10)
        self.cell(30, 10, 'EMP ID', 1)
        self.cell(40, 10, 'Current Shift', 1)
        self.cell(40, 10, 'Optimal Shift', 1)
        self.cell(80, 10, 'Action Taken', 1)
        self.ln()

        self.set_font('Arial', '', 9)
        changed = optimized[optimized['Action'] != 'Maintained'].head(20)
        for _, row in changed.iterrows():
            self.cell(30, 8, str(row['Employee_ID']), 1)
            self.cell(40, 8, str(row['Current_Shift']), 1)
            self.cell(40, 8, str(row['Optimal_Shift']), 1)
            self.cell(80, 8, str(row['Action']), 1)
            self.ln()

        self.output(output_path)
        return output_path
